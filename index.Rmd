---
output: html_document
---

<style type="text/css">
.navbar-header  {
    margin-left: -160px !important;
}
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

******

This webpage is an interative tool to explore a curated list of COVID-19 data sources, tools, and other resources organized by [Mathematica](https://www.mathematica.org/).

For detailed descriptions of all data sources, please visit Mathematicaâ€™s [COVID-19 Curated Data, Modeling, and Policy Resources](https://www.mathematica.org/features/covid-19-curated-data-modeling-and-policy-resources) webpage.

******

The diagram below visualizes the flow of data sources (on the left) to resources that compile multiple data sources. It can be used to understand what primary data sources are underlying key COVID-19 resources. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align='center')
library(tidyverse)
library(networkD3)
library(htmlwidgets)
library(here)
library(extrafont)
library(DT)
library(ggpubr)
library(gridExtra)
extrafont::loadfonts(device = "win", quiet = TRUE)
```

```{r, fig.width = 12, fig.height=0.5, dpi = 600}
legend <- c("Raw data" = "#F1B51C", 
            "Data compilation" = "#17A673")
legend_plot <- ggplot(as.data.frame(legend)) + 
  geom_bar(aes(x = legend, y = 1, fill = legend), stat = "identity") +
  scale_fill_manual(labels = names(legend), values = paste0(legend), name = "") +
  theme(legend.position = "bottom", 
    legend.text = element_text(family = "Zilla Slab", 
                               size = 12, 
                               margin = margin(r = 100, unit = 'points')))

as_ggplot(ggpubr::get_legend(legend_plot))
```

```{r}
agg <- read_csv(here("data/Aggregates.csv"))
data_cols <- names(agg)[-(1:7)] # first 6 columns aren't data source columns
data_cols <- data_cols[-(length(data_cols))]
df <- agg %>%
  select(-`NAHDO?`) %>%
  mutate(Other = if_else(!is.na(Other), 1, NA_real_)) %>%
  pivot_longer(cols = data_cols, 
               names_to = "data_source", 
               values_to = "flag") %>%
  filter(!is.na(flag)) %>%
  filter(data_source != `Source name`) %>% # filter out loops 
  mutate(`Source name` = if_else(grepl("Harvard", `Source name`), 
                                 "Boston Children's Hosp/Harvard", 
                                 `Source name`)) 

# define nodes
nodes <- data.frame("name" = c(df$data_source, df$`Source name`)) %>% unique()

# identify if nodes are primary, secondary, or tertiary sources
nodes <- nodes %>% 
  mutate(group = case_when(
    (name %in% df$data_source) ~ "raw", 
     TRUE ~ "compilation" 
  ))
  
group_cols <- 'd3.scaleOrdinal() .domain(["raw", "compilation"]) .range(["#F1B51C", "#17A673"])'
 
# define links 
links <- df %>% 
  select(from = data_source, to = `Source name`) %>% 
  mutate(value = 0.5) %>%
  as.data.frame() 
  
links$from_id <- match(links$from, nodes$name) - 1 
links$to_id <- match(links$to, nodes$name) - 1 

sn <- sankeyNetwork(Links = links, 
                    Nodes = nodes, 
                    Source = "from_id",
                    Target = "to_id", 
                    Value = "value", 
                    NodeID = "name", 
                    NodeGroup="group",
                    colourScale = group_cols, 
                    fontSize = 15,  
                    nodeWidth = 20, 
                    nodePadding = 20,
                    fontFamily = "Zilla Slab",
                    width = "100%", height=750,
                    sinksRight = T, 
                    margin = list("left"=250)) 

# move labels to right
onRender(sn,
  'function(el,x) {
    d3.selectAll(".node text")
      .attr("x", 6 + x.options.nodeWidth)
      .attr("text-anchor", "start");
  }'
) 
```



